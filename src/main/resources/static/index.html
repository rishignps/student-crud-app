<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Student Management App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
<div class="container py-5">

    <!-- HEADER -->
    <h2 class="text-center text-primary mb-4">🎓 Student Management</h2>

    <!-- FORM -->
    <form id="studentForm" class="card shadow-sm p-4 mb-4">
        <h5 class="mb-3">➕ Add New Student</h5>
        <input type="hidden" id="studentId" />
        <div class="row g-3">
            <div class="col-md-4">
                <input type="text" id="name" class="form-control" placeholder="Name" required />
            </div>
            <div class="col-md-4">
                <input type="email" id="email" class="form-control" placeholder="Email" required />
            </div>
            <div class="col-md-2">
                <input type="number" id="age" class="form-control" placeholder="Age" required />
            </div>
            <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-success">Save</button>
            </div>
        </div>
    </form>

    <!-- STUDENTS TABLE -->
    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="mb-3">📋 All Students</h5>

            <!-- 🔍 SEARCH BAR -->
            <div class="mb-3">
                <input
                        type="text"
                        id="searchInput"
                        class="form-control"
                        placeholder="🔍 Search by name, email, or ID..."
                />
            </div>

            <div class="table-responsive">
                <table class="table table-bordered align-middle text-center">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th><th>Name</th><th>Email</th><th>Age</th><th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                    <!-- Populated dynamically -->
                    </tbody>
                </table>
                <p id="emptyMessage" class="text-muted text-center mt-3 d-none">No students available.</p>
            </div>
        </div>
    </div>
</div>

<!-- TOAST -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="toast" class="toast align-items-center text-white bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toastMsg">Student saved!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = "http://localhost:8081/students";

    const form = document.getElementById("studentForm");
    const nameInput = document.getElementById("name");
    const emailInput = document.getElementById("email");
    const ageInput = document.getElementById("age");
    const idInput = document.getElementById("studentId");
    const toast = new bootstrap.Toast(document.getElementById("toast"));
    const toastMsg = document.getElementById("toastMsg");

    window.onload = loadStudents;

    form.addEventListener("submit", function (e) {
        e.preventDefault();

        const name = nameInput.value.trim();
        const email = emailInput.value.trim();
        const age = ageInput.value.trim();

        if (!name || !email || !age) {
            showToast("⚠️ All fields are required!", true);
            return;
        }

        const student = {
            name,
            email,
            age: parseInt(age)
        };

        const isEdit = idInput.value !== "";
        const url = isEdit ? `${API_URL}/${idInput.value}` : API_URL;
        const method = isEdit ? "PUT" : "POST";

        fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(student)
        })
            .then(res => {
                if (!res.ok) throw new Error("Request failed");
                return res.json();
            })
            .then(data => {
                showToast(isEdit ? "✅ Student updated!" : "✅ Student added!");
                form.reset();
                idInput.value = "";
                loadStudents();
            })
            .catch(err => {
                console.error(err);
                showToast("❌ Something went wrong!", true);
            });
    }); // ✅ this closing brace was missing!

    function loadStudents() {
        fetch(API_URL)
            .then(res => res.json())
            .then(data => {
                const tableBody = document.getElementById("studentsTableBody");
                const emptyMsg = document.getElementById("emptyMessage");

                tableBody.innerHTML = "";

                if (data.length === 0) {
                    emptyMsg.classList.remove("d-none");
                } else {
                    emptyMsg.classList.add("d-none");
                    data.forEach(student => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
              <td>${student.id}</td>
              <td>${student.name}</td>
              <td>${student.email}</td>
              <td>${student.age}</td>
              <td>
                <button class="btn btn-sm btn-warning me-2" onclick="editStudent(${student.id}, '${student.name}', '${student.email}', ${student.age})">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteStudent(${student.id})">Delete</button>
              </td>
            `;
                        tableBody.appendChild(row);
                    });
                }
            });
    }

    function editStudent(id, name, email, age) {
        nameInput.value = name;
        emailInput.value = email;
        ageInput.value = age;
        idInput.value = id;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteStudent(id) {
        if (confirm("Are you sure you want to delete this student?")) {
            fetch(`${API_URL}/${id}`, { method: "DELETE" })
                .then(() => {
                    showToast("🗑️ Student deleted!");
                    loadStudents();
                })
                .catch(err => showToast("❌ Delete failed!", true));
        }
    }

    function showToast(message, isError = false) {
        toastMsg.textContent = message;
        const toastEl = document.getElementById("toast");
        toastEl.classList.remove("bg-success", "bg-danger");
        toastEl.classList.add(isError ? "bg-danger" : "bg-success");
        toast.show();
    }

    // 🔍 Search functionality
    document.getElementById("searchInput").addEventListener("keyup", function () {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll("#studentsTableBody tr");

        rows.forEach((row) => {
            const cells = row.querySelectorAll("td");
            const match = [...cells].some((cell) =>
                cell.textContent.toLowerCase().includes(filter)
            );
            row.style.display = match ? "" : "none";
        });
    });
</script>

</body>
</html>
